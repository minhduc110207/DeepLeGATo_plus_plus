# DeepLeGATo++

## Next-Generation Galaxy Morphology Estimation with Transformers and Neural Posterior Estimation

**Python 3.9+** | **PyTorch 2.0+** | **MIT License** | **Optimized for Google Colab**

---

## üåå What Is This?

**DeepLeGATo++** (Deep Learning Galaxy Tool++) is a deep learning framework for **automated galaxy morphology estimation**. Given an image of a galaxy, the model predicts the structural parameters that describe its shape, size, brightness, and orientation ‚Äî along with **full uncertainty quantification** for each prediction.

This is critical in astrophysics: understanding galaxy morphology helps scientists study galaxy formation, evolution, and the large-scale structure of the universe. Traditional methods (like GALFIT) require manual fitting and are extremely slow for large surveys. DeepLeGATo++ automates this process using modern neural networks, processing thousands of galaxies in seconds.

### The Problem

Modern astronomical surveys (HST, JWST, Euclid, Rubin/LSST) produce **millions of galaxy images**. Each galaxy needs to be characterized by its **S√©rsic profile** ‚Äî a mathematical model that describes how a galaxy's brightness falls off from its center. Fitting these profiles traditionally requires:

- Manual initial parameter guesses
- Iterative optimization (slow, often fails)
- No built-in uncertainty estimates
- Hours per galaxy for complex cases

### The Solution

DeepLeGATo++ uses a **Swin Transformer V2** (a state-of-the-art vision model) combined with **Neural Posterior Estimation** (NPE) to:

1. **Extract multi-scale features** from galaxy images using the Swin Transformer backbone
2. **Estimate the full posterior distribution** of S√©rsic parameters using normalizing flows
3. **Provide calibrated uncertainties** ‚Äî not just a point estimate, but a probability distribution over all possible parameter values
4. **Process galaxies in batches** ‚Äî thousands of galaxies per minute on a single GPU

---

## üî≠ What Does the Model Predict?

The model estimates **7 S√©rsic profile parameters** for each galaxy image:

| Parameter | Symbol | Description | Prior Range |
|-----------|--------|-------------|-------------|
| **Magnitude** | mag | Total integrated brightness of the galaxy | [15, 28] mag |
| **Effective Radius** | R_eff | Half-light radius (size of the galaxy) | [0.1", 10"] |
| **S√©rsic Index** | n | Controls the shape of the light profile (n=1: exponential disk, n=4: de Vaucouleurs elliptical) | [0.3, 8] |
| **Axis Ratio** | q | Ellipticity (1 = circular, 0.1 = highly elongated) | [0.1, 1.0] |
| **Position Angle** | PA | Orientation of the galaxy's major axis | [0¬∞, 180¬∞] |
| **Center X** | x‚ÇÄ | Horizontal offset from image center | [¬±5 px] |
| **Center Y** | y‚ÇÄ | Vertical offset from image center | [¬±5 px] |

For each parameter, the model outputs:
- **Point estimate** (mean prediction)
- **Uncertainty** (standard deviation)
- **95% credible interval** (Bayesian confidence bounds)
- **Full posterior samples** (for custom analysis)

---

## üß† How Does It Work?

### Architecture

```
                    DeepLeGATo++ Architecture
                    
Galaxy Image ‚îÄ‚îÄ‚Üí Swin Transformer V2 ‚îÄ‚îÄ‚Üí NPE Head ‚îÄ‚îÄ‚Üí Posterior Distribution
  (128√ó128)         (Backbone)           (Flow)         (7 parameters)
                        ‚îÇ                   ‚îÇ
                  Multi-scale          Normalizing
                   Feature              Flows (MAF)
                  Extraction           Conditional on
                                      image features
```

1. **Swin Transformer V2 Backbone**: A hierarchical vision transformer that processes the galaxy image at multiple scales. It uses shifted windows for efficient self-attention, capturing both local details (galaxy center, spiral arms) and global structure (overall shape, orientation). Gradient checkpointing enables training on limited GPU memory.

2. **Neural Posterior Estimation (NPE) Head**: Instead of just predicting a single value for each parameter, the NPE head learns the full posterior distribution p(Œ∏|x) ‚Äî the probability of each possible parameter value given the observed image. This is done using **Masked Autoregressive Flows** (MAF), a type of normalizing flow that can model complex, multi-modal distributions.

3. **Parameter Transformation**: Since morphological parameters have physical bounds (e.g., axis ratio must be between 0 and 1), a sigmoid/logit transformation maps between the bounded physical space and an unbounded latent space where the flow operates.

### Training

- **Simulation-Based Inference (SBI)**: The model is trained entirely on **synthetic galaxy images** generated by a GPU-accelerated S√©rsic simulator with realistic noise (Poisson shot noise, read noise, sky background) and PSF convolution
- **Loss Function**: Combines Gaussian negative log-likelihood (for point estimates) with flow loss (for posterior estimation)
- **Self-supervised**: No real labeled data needed ‚Äî the simulator generates ground truth parameters

---

## ‚ö° Quick Start (Google Colab)

1. Upload this folder to Google Drive as `My Drive/DeepLeGATo++/`
2. Open `notebooks/03_Training.ipynb` in Google Colab
3. Run all cells ‚Äî training auto-resumes on disconnect!

```python
# Mount Drive and setup
from google.colab import drive
drive.mount('/content/drive')

import sys
sys.path.insert(0, '/content/drive/MyDrive/DeepLeGATo++')

# Install dependencies
!pip install -q torch pytorch-lightning timm nflows einops

# Start training
from deeplegato_pp.training import train
model = train(resume=True)
```

### Inference Example

```python
from deeplegato_pp.inference import Predictor
from deeplegato_pp.models import DeepLeGAToPP

# Load trained model
model = DeepLeGAToPP.load_pretrained("path/to/checkpoint")
predictor = Predictor(model, device="cuda")

# Predict galaxy parameters with uncertainties
result = predictor.predict(galaxy_image, num_samples=1000)
predictor.print_results(result)

# Output:
# Parameter        Mean ¬± Std       95% CI
# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
# Magnitude      22.34 ¬± 0.15    [22.05, 22.63]
# R_eff           1.82 ¬± 0.08    [ 1.67,  1.98]
# S√©rsic n        2.41 ¬± 0.23    [ 1.97,  2.86]
# Axis ratio      0.67 ¬± 0.03    [ 0.61,  0.73]
# PA            127.5¬∞ ¬± 2.1¬∞   [123.4¬∞, 131.6¬∞]
```

---

## üìÅ Project Structure

```
DeepLeGATo++/
‚îú‚îÄ‚îÄ configs/                 # YAML configuration files
‚îÇ   ‚îî‚îÄ‚îÄ colab_t4.yaml        # Config for T4 GPU (16GB)
‚îú‚îÄ‚îÄ deeplegato_pp/           # Main Python package
‚îÇ   ‚îú‚îÄ‚îÄ models/              # Neural network architectures
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ swin_backbone.py # Swin Transformer V2 feature extractor
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ npe_head.py      # Normalizing flow posterior estimator
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ deeplegato_pp.py # Combined model
‚îÇ   ‚îú‚îÄ‚îÄ data/                # Data generation & loading
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ sersic_simulator.py  # GPU-accelerated galaxy simulator
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ psf_handler.py       # Point Spread Function handling
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ dataset.py           # PyTorch datasets & dataloaders
‚îÇ   ‚îú‚îÄ‚îÄ training/            # Training infrastructure
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ trainer.py       # PyTorch Lightning trainer
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ losses.py        # NPE & physics-informed losses
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ colab_utils.py   # Google Colab helpers
‚îÇ   ‚îî‚îÄ‚îÄ inference/           # Prediction & analysis
‚îÇ       ‚îú‚îÄ‚îÄ predictor.py     # High-level prediction interface
‚îÇ       ‚îî‚îÄ‚îÄ uncertainty.py   # Calibration & UQ utilities
‚îú‚îÄ‚îÄ notebooks/               # Jupyter/Colab notebooks
‚îî‚îÄ‚îÄ requirements.txt         # Python dependencies
```

---

## üíª GPU Requirements

| GPU | VRAM | Batch Size | Estimated Training Time |
|-----|------|------------|------------------------|
| T4 (Colab Free) | 16 GB | 16 | ~8 hours |
| L4 (Colab Pro) | 24 GB | 32 | ~4 hours |
| A100 (Colab Pro+) | 40 GB | 64 | ~2 hours |

---

## üî¨ Scientific Background

### S√©rsic Profile

The S√©rsic profile is the standard model for describing galaxy surface brightness:

```
I(r) = I_e √ó exp( -b_n √ó [(r/R_e)^(1/n) - 1] )
```

Where:
- **I_e** is the intensity at the effective radius
- **R_e** is the effective (half-light) radius
- **n** is the S√©rsic index (shape parameter)
- **b_n** ‚âà 2n - 1/3 (normalization constant)

Different values of n correspond to different galaxy types:
- **n ‚âà 0.5**: Gaussian profile
- **n ‚âà 1**: Exponential disk (spiral galaxies)
- **n ‚âà 4**: de Vaucouleurs profile (elliptical galaxies)
- **n > 4**: Centrally concentrated profiles (giant ellipticals)

### Neural Posterior Estimation

Unlike traditional methods that find a single best-fit, NPE learns the full posterior distribution p(Œ∏|x), answering: *"Given this galaxy image, what are all the plausible parameter values and how likely is each?"* This is achieved using conditional normalizing flows ‚Äî invertible neural networks that transform a simple base distribution into a complex posterior, conditioned on the image features.

---

## üèóÔ∏è Built With

- [PyTorch](https://pytorch.org/) ‚Äî Deep learning framework
- [PyTorch Lightning](https://lightning.ai/) ‚Äî Training infrastructure
- [timm](https://github.com/huggingface/pytorch-image-models) ‚Äî Swin Transformer V2 implementation
- [nflows](https://github.com/bayesiains/nflows) ‚Äî Normalizing flows for NPE
- [Astropy](https://www.astropy.org/) ‚Äî FITS file handling

---

## üìñ References

- **Original DeepLeGATo**: Tuccillo et al., *"Deep learning for galaxy surface brightness profile fitting"*, MNRAS, 2018 ([arXiv:1711.03108](https://arxiv.org/abs/1711.03108))
- **Swin Transformer V2**: Liu et al., *"Swin Transformer V2: Scaling Up Capacity and Resolution"*, CVPR, 2022
- **Neural Posterior Estimation**: Papamakarios et al., *"Sequential Neural Likelihood"*, AISTATS, 2019
- **S√©rsic Profile**: S√©rsic, J.L., *"Influence of the atmospheric and instrumental dispersion on the brightness distribution in a galaxy"*, 1963

## Citation

If you use DeepLeGATo++ in your research, please cite:

```bibtex
@article{deeplegato_pp_2025,
  title={DeepLeGATo++: Galaxy Profile Fitting with Transformers and Neural Posterior Estimation},
  year={2025}
}

@article{tuccillo2018deep,
  title={Deep learning for galaxy surface brightness profile fitting},
  author={Tuccillo, D. and others},
  journal={MNRAS},
  year={2018}
}
```

## License

MIT License ‚Äî see [LICENSE](LICENSE) for details.
